<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- MOBILE WEB APP META TAGS (To hide bars) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <title>CYBER RACING: TRUE FULLSCREEN</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700;900&display=swap');

        /* --- FORCED FULLSCREEN STYLES --- */
        html, body {
            width: 100%; height: 100%;
            margin: 0; padding: 0;
            overflow: hidden; /* No scrolling */
            background: #000;
            position: fixed; /* Lock body to prevent bounce */
            font-family: 'Rajdhani', sans-serif;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
        }

        /* --- PORTRAIT LOCK WARNING --- */
        #rotate-message {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 99999;
            flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        
        .phone-anim {
            width: 50px; height: 90px;
            border: 4px solid #00f3ff; border-radius: 8px;
            animation: turnPhone 1.5s infinite ease-in-out;
            margin-bottom: 20px; box-shadow: 0 0 15px #00f3ff;
        }
        @keyframes turnPhone {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
            100% { transform: rotate(0deg); }
        }
        .rotate-text {
            color: #fff; font-size: 20px; font-weight: 800; letter-spacing: 2px;
            text-shadow: 0 0 10px #ff0055;
        }

        /* If Portrait, show warning, hide everything else */
        @media screen and (orientation: portrait) {
            #rotate-message { display: flex; }
            #game-wrapper { visibility: hidden; }
        }

        /* --- GAME CONTAINER --- */
        #game-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #020205; overflow: hidden; visibility: visible;
        }

        /* --- UI & HUD --- */
        .speed-lines { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, transparent 40%, rgba(255,255,255,0.15) 80%); z-index:15; opacity:0; pointer-events:none; transition:0.1s; }
        .vignette { position: absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle, transparent 60%, rgba(0,0,0,0.95) 100%); pointer-events:none; z-index:10; }
        
        #ui-layer { position: absolute; top:0; left:0; width:100%; height:100%; padding:10px; box-sizing:border-box; z-index:20; pointer-events:none; }
        
        /* SETTINGS BUTTON */
        #settings-btn { position: absolute; top:15px; right:15px; font-size:30px; cursor:pointer; pointer-events:auto; z-index:250; filter:drop-shadow(0 0 5px #00f3ff); }
        
        /* SETTINGS MODAL */
        #settings-modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:300; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .settings-box { width:400px; max-width:90%; background:#0a141e; border:2px solid #00f3ff; padding:20px; border-radius:15px; text-align:center; }
        .set-row { display:flex; justify-content:space-between; margin-bottom:20px; color:#fff; font-weight:bold; font-size:18px; align-items:center; }
        .c-opt { padding:5px 15px; background:#222; border:1px solid #555; cursor:pointer; }
        .c-opt.selected { background:#00f3ff; color:#000; }
        .toggle-switch { width:50px; height:25px; background:#333; border-radius:20px; position:relative; cursor:pointer; }
        .toggle-switch.active { background:#00f3ff; }
        .toggle-knob { width:21px; height:21px; background:#fff; border-radius:50%; position:absolute; top:2px; left:2px; transition:0.2s; }
        .toggle-switch.active .toggle-knob { left:27px; }
        .close-set-btn { padding:10px 30px; background:none; border:2px solid #ff0055; color:#ff0055; font-weight:900; cursor:pointer; }

        /* CLOCK & INFO */
        #clock-container { position:absolute; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,10,20,0.8); border:1px solid #00f3ff; padding:4px 15px; border-radius:20px; color:#fff; font-weight:800; font-size:18px; display:flex; gap:10px; z-index:40; pointer-events:auto; }
        #clock-toggle { background:#00f3ff; border:none; font-weight:900; font-size:10px; padding:2px 6px; border-radius:3px; cursor:pointer; }
        
        #progress-track { position:absolute; top:50px; left:50%; transform:translateX(-50%); width:40%; height:6px; background:#333; border-radius:3px; z-index:30; }
        #progress-bar { height:100%; width:0%; background:#00f3ff; box-shadow:0 0 10px #00f3ff; border-radius:3px; }
        #flag-icon { position:absolute; right:-10px; top:-12px; font-size:16px; }

        .level-card { position:absolute; top:60px; left:20px; background:rgba(0,0,0,0.7); border-left:5px solid #ff0055; padding:5px 20px; transform:skewX(-15deg); }
        .lvl-val { color:#ff0055; font-size:30px; font-weight:900; }

        /* RIGHT HUD */
        .hud-right { position:absolute; top:60px; right:15px; display:flex; flex-direction:column; align-items:flex-end; }
        .tacho-box { width:140px; height:140px; position:relative; }
        .dial-svg { width:100%; height:100%; transform:rotate(135deg); }
        .dial-bg { fill:none; stroke:#222; stroke-width:12; }
        .dial-fg { fill:none; stroke:#00f3ff; stroke-width:12; stroke-dasharray:251; stroke-dashoffset:251; transition:stroke-dashoffset 0.1s; filter:drop-shadow(0 0 5px #00f3ff); }
        .speed-num { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:35px; font-weight:900; }
        
        .gear-display { position:absolute; bottom:5px; right:120px; text-align:right; }
        .gear-num { font-size:50px; font-weight:900; color:#ffcc00; text-shadow:0 0 15px #ffcc00; line-height:0.8; }
        .gear-txt { font-size:12px; color:#ffcc00; font-weight:bold; }

        .gear-btns { position:absolute; top:50%; right:160px; transform:translateY(-50%); display:flex; flex-direction:column; gap:10px; pointer-events:auto; }
        .g-btn { width:55px; height:55px; background:rgba(0,30,60,0.8); border:2px solid #00f3ff; border-radius:10px; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:900; font-size:12px; background-size:70%; background-repeat:no-repeat; background-position:center; cursor:pointer; }
        .g-btn:active { background-color:#00f3ff; transform:scale(0.95); }
        #btn-gear-up { background-image: url('https://n.f-a-k.workers.dev/png-transparent-car-gear-shifter.png'); }
        #btn-gear-down { background-image: url('https://n.f-a-k.workers.dev/png-clipart-car-gear-stick-manual-transmission-car.png'); }

        #nitro-container { position:absolute; bottom:20px; right:20px; width:220px; height:8px; background:#222; border:1px solid #555; transform:skewX(-20deg); }
        #nitro-fill { width:100%; height:100%; background:linear-gradient(90deg, #ff0055, #ffcc00); box-shadow:0 0 10px #ff0055; }

        /* CONTROLS */
        #controls { position:absolute; bottom:10px; width:100%; display:flex; justify-content:space-between; padding:0 30px; z-index:50; pointer-events:none; }
        .touch-area { pointer-events:auto; display:flex; gap:20px; }
        .c-btn { width:80px; height:80px; border-radius:50%; background:rgba(255,255,255,0.05); border:2px solid rgba(255,255,255,0.2); color:#00f3ff; font-size:30px; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .c-btn:active { background:#00f3ff; color:#000; box-shadow:0 0 30px #00f3ff; }
        .nitro-btn { border-color:#ff0055; color:#ff0055; }
        .nitro-btn:active { background:#ff0055; color:#fff; box-shadow:0 0 30px #ff0055; }

        /* MENUS */
        #menu-layer { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(2,2,8,0.98); z-index:200; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        h1 { font-size:70px; color:#fff; font-weight:900; font-style:italic; text-align:center; line-height:0.9; margin:0; }
        h1 span { color:#00f3ff; display:block; font-size:24px; letter-spacing:10px; margin-top:5px; }
        
        .big-btn { margin-top:40px; padding:15px 60px; font-size:24px; font-weight:900; background:#fff; border:none; transform:skewX(-10deg); cursor:pointer; box-shadow:10px 10px 0 #00f3ff; transition:0.2s; pointer-events:auto; }
        .big-btn:active { transform:skewX(-10deg) translate(5px,5px); box-shadow:0 0 0; }
        
        #result-box { display:none; border:4px solid #fff; padding:15px 40px; margin-bottom:20px; text-align:center; background:#000; }
        #countdown-overlay { position:absolute; top:0; left:0; width:100%; height:100%; display:none; align-items:center; justify-content:center; z-index:150; pointer-events:none; }
        #cnt-txt { font-size:150px; font-weight:900; color:#fff; text-shadow:5px 5px 0 #ff0055; font-style:italic; }
        .hidden { display:none !important; }
        
        #footer-credit { position: absolute; bottom: 5px; width: 100%; text-align: center; color: #fff; font-size: 12px; font-weight: 800; letter-spacing: 4px; z-index: 100; text-shadow: 0 0 10px #00f3ff; opacity: 0.7; }

    </style>
    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>
</head>
<body>

    <div id="rotate-message">
        <div class="phone-anim"></div>
        <div class="rotate-text">PLEASE ROTATE DEVICE üîÑ</div>
    </div>

    <div id="game-wrapper">
        <div class="vignette"></div>
        <div class="speed-lines" id="speed-lines"></div>
        <div id="footer-credit">MADE BY FAIZAN AHMED</div>

        <!-- SETTINGS -->
        <div id="settings-btn">‚öôÔ∏è</div>
        <div id="settings-modal">
            <div class="settings-box">
                <div class="set-title">SETTINGS</div>
                <div class="set-row">
                    <div class="set-label">AUDIO</div>
                    <div class="toggle-switch active" id="audio-toggle"><div class="toggle-knob"></div></div>
                </div>
                <div class="set-row">
                    <div class="set-label">CONTROLS</div>
                    <div class="ctrl-select">
                        <div class="c-opt selected" id="opt-btn">BUTTONS</div>
                        <div class="c-opt" id="opt-tilt">TILT</div>
                    </div>
                </div>
                <button class="close-set-btn" id="close-settings">SAVE & CLOSE</button>
            </div>
        </div>

        <div id="ui-layer">
            <div id="clock-container"><span id="clock-time">00:00</span><button id="clock-toggle">24H</button></div>
            <div id="progress-track"><div id="progress-bar"></div><div id="flag-icon">üèÅ</div></div>
            <div class="level-card"><div class="lvl-val" id="level-num">1</div></div>

            <div class="hud-right">
                <div class="tacho-box">
                    <svg class="dial-svg" viewBox="0 0 100 100"><circle class="dial-bg" cx="50" cy="50" r="40"></circle><circle class="dial-fg" id="rpm-ring" cx="50" cy="50" r="40"></circle></svg>
                    <div class="speed-num" id="speed-display">0</div>
                </div>
                <div class="gear-display"><div class="gear-txt">GEAR</div><div class="gear-num" id="gear-display">1</div></div>
                <div class="gear-btns"><div class="g-btn" id="btn-gear-up">UP</div><div class="g-btn" id="btn-gear-down">DOWN</div></div>
                <div id="nitro-container"><div id="nitro-fill"></div></div>
            </div>

            <div id="controls">
                <div class="touch-area" id="steering-area"><div class="c-btn" id="btn-left">‚óÄ</div><div class="c-btn" id="btn-right">‚ñ∂</div></div>
                <div class="touch-area"><div class="c-btn nitro-btn" id="btn-nitro">‚ö°</div></div>
            </div>
        </div>

        <div id="countdown-overlay"><div id="cnt-txt">3</div></div>

        <div id="menu-layer">
            <h1>CYBER<br>OMEGA<span>FULLSCREEN ED.</span></h1>
            <div id="result-box"><div style="font-size:40px; font-weight:900; font-style:italic;" id="result-title">VICTORY</div></div>
            <div style="color:#00f3ff; font-weight:bold; letter-spacing:5px;" id="menu-lvl-name">LEVEL 1</div>
            <button class="big-btn" id="start-btn">INITIATE RACE</button>
        </div>
    </div>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    // --- GAME STATE ---
    const OPTS={ audio:true, mode:'buttons', tilt:0 };
    const LANE_WIDTH=5, GEAR_MAX=[0, 0.4, 0.8, 1.4, 1.9, 2.5, 3.4];
    const LEVELS=[
        {id:1,name:"ROOKIE",dist:1200,rivals:1,spd:0.75}, {id:2,name:"STREET",dist:1800,rivals:2,spd:0.9},
        {id:3,name:"DRIFT",dist:2400,rivals:2,spd:1.0}, {id:4,name:"CHASE",dist:3000,rivals:3,spd:1.2},
        {id:5,name:"OMEGA",dist:4000,rivals:3,spd:1.5}, {id:6,name:"GOD",dist:5000,rivals:4,spd:2.0}
    ];

    let scene,camera,renderer,composer,player,rivals=[],city=[],parts=[],running=false,score=0,speed=0,nitro=100,gear=1,lvlIdx=0,laneX=0,targetX=0,shake=0,input={l:false,r:false,n:false};
    
    // --- FULLSCREEN FUNCTION ---
    const goFull = () => {
        const doc = document.documentElement;
        if(doc.requestFullscreen) doc.requestFullscreen();
        else if(doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
    };

    // --- CLOCK ---
    let is24=false;
    const ut=()=>{ const d=new Date(); let h=d.getHours(),m=String(d.getMinutes()).padStart(2,'0'); if(!is24){h=h%12||12;} document.getElementById('clock-time').innerText=`${String(h).padStart(2,'0')}:${m}`; };
    setInterval(ut,1000); ut(); document.getElementById('clock-toggle').onclick=()=>{is24=!is24;document.getElementById('clock-toggle').innerText=is24?'12H':'24H';ut();};

    // --- SETTINGS UI ---
    const initSet=()=>{
        const m=document.getElementById('settings-modal'), b=document.getElementById('settings-btn'), c=document.getElementById('close-settings');
        const st=document.getElementById('steering-area');
        b.onclick=()=>m.style.display='flex'; c.onclick=()=>m.style.display='none';
        document.getElementById('audio-toggle').onclick=function(){ OPTS.audio=!OPTS.audio; this.classList.toggle('active'); };
        document.getElementById('opt-btn').onclick=function(){ OPTS.mode='buttons'; this.classList.add('selected'); document.getElementById('opt-tilt').classList.remove('selected'); st.style.opacity='1'; st.style.pointerEvents='auto'; };
        document.getElementById('opt-tilt').onclick=function(){ 
            OPTS.mode='tilt'; this.classList.add('selected'); document.getElementById('opt-btn').classList.remove('selected'); st.style.opacity='0'; st.style.pointerEvents='none';
            if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function') DeviceOrientationEvent.requestPermission().catch(console.error);
        };
    }; initSet();

    window.addEventListener('deviceorientation',e=>{ if(OPTS.mode==='tilt'){ let t=e.gamma; if(Math.abs(window.orientation)===90)t=e.beta; OPTS.tilt=t>5?1:(t<-5?-1:0); } });

    // --- INIT ---
    function init(){
        scene=new THREE.Scene(); scene.fog=new THREE.FogExp2(0x020205,0.02);
        camera=new THREE.PerspectiveCamera(80, window.innerWidth/window.innerHeight, 0.1, 1000); camera.position.set(0,2.5,6);
        renderer=new THREE.WebGLRenderer({antialias:false,powerPreference:"high-performance"});
        renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
        document.getElementById('game-wrapper').appendChild(renderer.domElement);
        
        composer=new EffectComposer(renderer); composer.addPass(new RenderPass(scene,camera));
        const bp=new UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1.5,0.4,0.85); bp.threshold=0; bp.strength=1.5; bp.radius=0.5; composer.addPass(bp);

        const amb=new THREE.AmbientLight(0xffffff,0.5); scene.add(amb);
        const dl=new THREE.DirectionalLight(0xffffff,0.8); dl.position.set(0,20,-10); scene.add(dl);

        // Build World
        const rG=new THREE.PlaneGeometry(100,1000), rM=new THREE.MeshStandardMaterial({color:0x111111,roughness:0.1});
        const rd=new THREE.Mesh(rG,rM); rd.rotation.x=-Math.PI/2; rd.position.z=-200; scene.add(rd);
        const gd=new THREE.GridHelper(100,20,0x00f3ff,0x111111); gd.position.y=0.05; gd.scale.z=5; scene.add(gd);
        
        const sg=new THREE.BufferGeometry(), sp=new Float32Array(2000*3);
        for(let i=0;i<6000;i++) sp[i]=(Math.random()-0.5)*500;
        sg.setAttribute('position',new THREE.BufferAttribute(sp,3));
        scene.add(new THREE.Points(sg,new THREE.PointsMaterial({color:0xffffff,size:0.6})));

        player=buildCar(0x00f3ff,0x050505); 
        const hl=new THREE.SpotLight(0xffffff,5,40,0.5,0.5,1); hl.position.set(0,0.6,-1.5); hl.target.position.set(0,0,-10); player.add(hl); player.add(hl.target);
        scene.add(player);

        setupInput();
        window.addEventListener('resize', ()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); composer.setSize(window.innerWidth,window.innerHeight); });
        anim();
    }

    function buildCar(c,b){
        const g=new THREE.Group(), bm=new THREE.MeshStandardMaterial({color:b,roughness:0.2});
        const bd=new THREE.Mesh(new THREE.BoxGeometry(2.2,0.6,4.5),bm); bd.position.y=0.6; g.add(bd);
        const tr=new THREE.Mesh(new THREE.BoxGeometry(2.25,0.1,4.6),new THREE.MeshBasicMaterial({color:c})); tr.position.y=0.4; g.add(tr);
        const gl=new THREE.Mesh(new THREE.BoxGeometry(1.8,0.4,1.5),new THREE.MeshBasicMaterial({color:0x000000})); gl.position.set(0,1,0.5); gl.rotation.x=-0.2; g.add(gl);
        const ug=new THREE.PointLight(c,2,8); ug.position.y=0.5; g.add(ug);
        return g;
    }

    function shift(d){
        if(!running)return;
        const og=gear; gear=Math.max(1,Math.min(6,gear+d));
        if(gear!==og){document.getElementById('gear-display').innerText=gear; shake=0.2;}
    }

    function startSeq(){
        goFull(); // TRIGGER FULLSCREEN ON TAP
        document.getElementById('menu-layer').classList.add('hidden');
        document.getElementById('settings-btn').style.display='none';
        const ov=document.getElementById('countdown-overlay'), tx=document.getElementById('cnt-txt');
        ov.style.display='flex'; let c=3; tx.innerText=c;
        const iv=setInterval(()=>{ c--; if(c>0)tx.innerText=c; else if(c===0){tx.innerText="GO!";tx.style.color="#00f3ff";} else{clearInterval(iv);ov.style.display='none';race();} },1000);
    }

    function race(){
        if(lvlIdx>=LEVELS.length){ document.querySelector('h1').innerHTML="CHAMPION"; document.getElementById('start-btn').classList.add('hidden'); document.getElementById('menu-layer').classList.remove('hidden'); return; }
        const l=LEVELS[lvlIdx]; document.getElementById('level-num').innerText=l.id; document.getElementById('menu-lvl-name').innerText=l.name;
        running=true; score=0; speed=0; nitro=100; gear=1; shake=0; document.getElementById('gear-display').innerText="1";
        rivals.forEach(r=>scene.remove(r.mesh)); rivals=[]; city.forEach(o=>scene.remove(o)); city=[];
        player.position.set(0,0,0); laneX=0; targetX=0;
        for(let i=0;i<l.rivals;i++){
            const rm=buildCar(0xff0055,0x333333); scene.add(rm); const sl=(i%3-1)*LANE_WIDTH; rm.position.set(sl,0,-15-(i*20));
            rivals.push({mesh:rm, lx:sl, tx:sl, z:0, t:Math.random(), s:0.95+Math.random()*0.15});
        }
    }

    function end(w){
        running=false; shake=0;
        const m=document.getElementById('menu-layer'), r=document.getElementById('result-box'), t=document.getElementById('result-title'), b=document.getElementById('start-btn');
        m.classList.remove('hidden'); r.style.display='block'; document.getElementById('settings-btn').style.display='block';
        if(w){ t.innerText="VICTORY"; t.style.color="#00f3ff"; r.style.borderColor="#00f3ff"; lvlIdx++; b.innerText="NEXT"; }
        else{ t.innerText="DEFEAT"; t.style.color="#ff0055"; r.style.borderColor="#ff0055"; b.innerText="RETRY"; }
    }

    function update(dt){
        if(!running)return;
        const l=LEVELS[lvlIdx];
        if(OPTS.mode==='buttons') targetX=input.l?-LANE_WIDTH:(input.r?LANE_WIDTH:0);
        else targetX=OPTS.tilt<-0.5?-LANE_WIDTH:(OPTS.tilt>0.5?LANE_WIDTH:0);
        
        laneX+=(targetX-laneX)*8*dt; player.position.x=laneX; player.rotation.z=(laneX-targetX)*0.1;
        let ms=GEAR_MAX[gear], ac=1.5*dt;
        if(input.n&&nitro>0){ac*=3.5;ms*=1.4;nitro-=30*dt;shake=Math.max(shake,0.15);document.getElementById('speed-lines').style.opacity=1;}
        else{if(nitro<100)nitro+=8*dt;document.getElementById('speed-lines').style.opacity=speed>2.5?0.6:0;}
        if(speed<ms)speed+=ac; else speed-=ac*0.5; speed-=0.12*dt; if(speed<0)speed=0;
        score+=speed*100*dt; const mv=speed*90*dt;

        document.getElementById('speed-display').innerText=Math.floor(speed*180);
        document.getElementById('nitro-fill').style.width=Math.max(0,nitro)+"%";
        document.getElementById('rpm-ring').style.strokeDashoffset=251-(Math.min(speed/3.5,1)*251);

        let fail=false;
        rivals.forEach(r=>{
            r.z-=(l.spd*r.s-speed)*85*dt; r.t+=dt; if(r.t>1.5){r.t=0; r.tx=(Math.floor(Math.random()*3)-1)*LANE_WIDTH;}
            r.lx+=(r.tx-r.lx)*6*dt; r.mesh.position.set(r.lx,0,r.z);
            const pb=new THREE.Box3().setFromObject(player).expandByScalar(-0.6), rb=new THREE.Box3().setFromObject(r.mesh).expandByScalar(-0.6);
            if(pb.intersectsBox(rb)){speed*=0.6;shake=1.0; if(player.position.x<r.mesh.position.x){laneX-=2;r.lx+=2;}else{laneX+=2;r.lx-=2;}}
            if(r.z<-3)fail=true;
        });

        if(Math.random()<0.1){
            const g=new THREE.BoxGeometry(5,20+Math.random()*60,5), m=new THREE.MeshBasicMaterial({color:0x0a0a25,wireframe:true});
            const lm=new THREE.Mesh(g,m); lm.position.set(-40-Math.random()*20,0,-500); const rm=new THREE.Mesh(g,m); rm.position.set(40+Math.random()*20,0,-500);
            scene.add(lm); scene.add(rm); city.push(lm,rm);
        }
        city.forEach((o,i)=>{o.position.z+=mv; if(o.position.z>20){scene.remove(o);city.splice(i,1);}});

        const p=Math.min(score/l.dist,1); document.getElementById('progress-bar').style.width=(p*100)+"%";
        if(score>=l.dist){let w=true; rivals.forEach(r=>{if(r.mesh.position.z<0)w=false;}); end(w);}

        if(shake>0){camera.position.set((Math.random()-0.5)*shake, 2.5+(Math.random()-0.5)*shake, 6); shake*=0.9;} else camera.position.set(0,2.5,6);
    }

    function setupInput(){
        const d=(k)=>{if(k==='l')input.l=true;if(k==='r')input.r=true;if(k==='n')input.n=true;if(k==='u')shift(1);if(k==='d')shift(-1);};
        const u=(k)=>{if(k==='l')input.l=false;if(k==='r')input.r=false;if(k==='n')input.n=false;};
        const b=(i,k)=>{const e=document.getElementById(i); e.onpointerdown=x=>{x.preventDefault();d(k)}; e.onpointerup=x=>{x.preventDefault();u(k)}; e.onpointerleave=x=>{x.preventDefault();u(k)};};
        b('btn-left','l'); b('btn-right','r'); b('btn-nitro','n'); b('btn-gear-up','u'); b('btn-gear-down','d');
        window.onkeydown=e=>{if(e.key==='ArrowLeft')d('l');if(e.key==='ArrowRight')d('r');if(e.key===' ')d('n');if(e.key==='ArrowUp')d('u');if(e.key==='ArrowDown')d('d');};
        window.onkeyup=e=>{if(e.key==='ArrowLeft')u('l');if(e.key==='ArrowRight')u('r');if(e.key===' ')u('n');};
        document.getElementById('start-btn').onclick=startSeq;
    }

    const clk=new THREE.Clock(); function anim(){requestAnimationFrame(anim); update(clk.getDelta()); composer.render();}
    init();
</script>
</body>
</html>